#!/bin/bash

usescore=0
dumpit=0
timeit=0
usewindows=0
num=200

VUSER=$VIVUSER
VPW=$VIVPW
VCOLLECTION=$VIVCOLLECTION
HOST=$VIVHOST
PORT=$VIVPORT
QUERY=""
DEFOUTPUT=$VIVQUERYOUTPUT
LOGFILE=$VIVLOGFILE
TARGETOS=$VIVTARGETOS
SEARCH_FILE_DIR=$FILE_SEED_HOME
#
#   An environment thing created to aid new test creation.
#
DOCOPY=$NEWTESTSAVE

CMP_FILE_DIR=$VIVQUERYCMPFILES
if [ "$CMP_FILE_DIR" == "" ]; then
   CMP_FILE_DIR=query_cmp_files
fi

while getopts "DC:U:P:Q:H:p:O:L:T:S:swr:n:" flag; do
  case "$flag" in
     C) VCOLLECTION=$OPTARG;;
     U) VUSER=$OPTARG;;
     P) VPW=$OPTARG;;
     Q) QUERY=$OPTARG;;
     H) HOST=$OPTARG;;
     p) PORT=$OPTARG;;
     O) DEFOUTPUT=$OPTARG;;
     L) LOGFILE=$OPTARG;;
     S) SEARCH_FILE_DIR=$OPTARG;;
     D) dumpit=1;;
     T) TESTNAME=$OPTARG;;
     n) num=$OPTARG;;
     w) usewindows=1;;
     s) usescore=1;;
     r) RIGHTS=$OPTARG; rightsarg="-r";;
     *) echo "Usage: run_query -C <collection> -U <user> -P <password>"
        echo "                 -Q <query> -H <hostid> -p <port>"
        echo "                 -O <query-output-file> -L <query-log-file>"
        echo "                 -S <file-seed-home-directory> -s"
	echo "		       -r <rights>"
        exit 1;;
  esac
done

CMP_SUFFIX="cmp"
if [ "$TARGETOS" == "windows" ]; then
   if [ $usewindows -eq 1 ]; then
      CMP_SUFFIX="cmp.windows"
   fi
fi

if [ "$VCOLLECTION" == "" ]; then
   echo "Collection name must be specified"
   echo "Use the -C <collection> option"
   exit 1
fi

#if [ "$QUERY" == "" ]; then
#   echo "Query must be specified"
#   echo "Use the -Q <query> option"
#   exit 1
#fi

if [ "$PORT" != "" ]; then
   export VIVPORT=$PORT
else
   export VIVPORT=7205
fi

if [ "$HOST" != "" ]; then
   export VIVHOST=$HOST
fi

if [ "$LOGFILE" == "" ]; then
   LOGFILE=/dev/null
fi

if [ "$DEFOUTPUT" == "" ]; then
   DEFOUTPUT="query_results"
fi

if [ "$VUSER" != "" ]; then
   export VIVUSER=$VUSER
fi

if [ "$VPW" != "" ]; then
   export VIVPW=$VPW
fi

if [ "$dumpit" -eq 1 ]; then
   echo "Collection = $VCOLLECTION  (-C option) or (VIVCOLLECTION env var)"
   echo "Query = $QUERY             (-Q option) or (VIVQUERY env var)"
   echo "Output file = $DEFOUTPUT   (-O option) or (VIVQUERYOUTPUT env var)"
   echo "Log file = $LOGFILE        (-L option) or (VIVLOGFILE env var)"
   echo "Host = $HOST               (-H option) or (VIVHOST env var)"
   echo "Port = $PORT               (-p option) or (VIVPORT env var)"
   echo "User = $VUSER              (-U option) or (VIVUSER env var)"
   echo "Password = $VPW            (-P option) or (VIVCOLLECTION env var)"
   exit 0
fi

if [ "$SEARCH_FILE_DIR" != "" ]; then
   filename=`mktemp`
   echo $SEARCH_FILE_DIR | sed "s/\//\\\\\//g" > $filename
   replstr=`cat $filename`
   xxx="sed \"s/\/home\/williams/$replstr/g\""
   rm $filename
else
   SEARCH_FILE_DIR=/tmp/thesearchers
   xxx="cat"
fi

echo "################  $TESTNAME start  ##################"
echo "$TESTNAME:  query = $QUERY"

if [ "$QUERY" == "" ]; then
   qQUERY="NoQuErY"
else
   qQUERY=$QUERY
fi

mkdir -p querywork

qryrslt=`xmlresultfile -t query -q $qQUERY`
qryurirslt=`uriresultfile -t query -q $qQUERY`

qryuridiff=`uridifffile -t query -q $qQUERY`
qryxmldiff=`xmldifffile -t query -q $qQUERY`

qrycmp=`xmlcomparefile -t query -q $qQUERY`
qryuricmp=`uricomparefile -t query -q $qQUERY`

if [ "$QUERY" != "" ]; then
   rstring="$TEST_ROOT/utils/bin/run_query -C $VCOLLECTION -Q $QUERY -O querywork/$qryrslt $rightsarg $RIGHTS -n $num"
else
   rstring="$TEST_ROOT/utils/bin/run_query -C $VCOLLECTION -O querywork/$qryrslt $rightsarg $RIGHTS -n $num"
fi


eval $rstring

if [ -f querywork/$qryrslt ]; then
   xyz=`stat -c %s querywork/$qryrslt`
else
   xyz=0
fi


if [ $xyz -eq 0 ]; then

   echo "$TESTNAME:  WARNING"
   echo "$TESTNAME:      Search on query $QUERY returned a result file"
   echo "$TESTNAME:      that is empty"

   res1=1

else

   if [ ! -f $CMP_FILE_DIR/$qrycmp ]; then
      echo "Query compare file $CMP_FILE_DIR/$qrycmp not found"
      echo "$TESTNAME:  Test Failed"
      #
      #   An environment thing created to aid new test creation.
      #
      if [ "$DOCOPY" == "Yes" ]; then
         mkdir -p $CMP_FILE_DIR
         echo "Doing copy:  querywork/$qryrslt to $CMP_FILE_DIR/$qrycmp"
         cp querywork/$qryrslt $CMP_FILE_DIR/$qrycmp
      fi
      echo "################  $TESTNAME end    ##################"
      exit 1
   fi

   #cp $TEST_ROOT/files/$VCOLLECTION/compare_files/$QUERY.$CMP_SUFFIX .

   if [ $usescore -eq 1 ]; then
      xsltproc $TEST_ROOT/utils/xsl/stripper querywork/$qryrslt > querywork/$qryurirslt
      xsltproc $TEST_ROOT/utils/xsl/stripper $CMP_FILE_DIR/$qrycmp | eval $xxx > querywork/$qryuricmp
   else
      xsltproc $TEST_ROOT/utils/xsl/noscore_stripper querywork/$qryrslt > querywork/$qryurirslt
      xsltproc $TEST_ROOT/utils/xsl/noscore_stripper $CMP_FILE_DIR/$qrycmp | eval $xxx > querywork/$qryuricmp
   fi

   diff querywork/$qryurirslt querywork/$qryuricmp > querywork/$qryuridiff
   res1=$?
   diff querywork/$qryrslt $CMP_FILE_DIR/$qrycmp > querywork/$qryxmldiff
   res2=$?

   if [ $res2 -ne 0 ];then
      echo "$TESTNAME:  WARNING"
      echo "$TESTNAME:      Search on query $QUERY returned a result file"
      echo "$TESTNAME:      that is different than that which is stored for comparison"
   fi

fi

if [ $res1 -eq 0 ];then
   echo "$TESTNAME:  Test Passed"
   #if [ $res2 -eq 0 ];then
   #   rm querywork/$QUERY.*
   #fi
else
   echo "$TESTNAME:  Test Failed"
fi
echo "################  $TESTNAME end    ##################"

if [ $res1 -eq 0 ];then
   exit 0
else
   exit 1
fi

#!/bin/bash
#
#  Pyed
#

###########################################################

   VUSER=""
   VPW=""
   VCOLLECTION=""
   VWORKINGDIR=$TESTWORKINGDIR
   VWWWUSER=""
   HOST=""
   TARGETOS="$VIVTARGETOS"

   ADMINCMD="admin"
   if [ "$TARGETOS" == "windows" ]; then
      ADMINCMD="admin.exe"
   fi

   VCMD="cgi-string"
   VACTION="start-crawler"
   export PATH=$PATH:$TEST_ROOT/utils/bin:$TEST_ROOT/bin

###########################################################

getsetopts()
{
   OPTERR=0
   OPTIND=1
   while getopts "H:C:U:P:W:" flag; do
     case "$flag" in
        C) VCOLLECTION=$OPTARG;;
        H) HOST=$OPTARG;;
        U) VUSER=$OPTARG;;
        P) VPW=$OPTARG;;
        W) VWORKINGDIR=$OPTARG;;
        *) echo "Usage: start_crawl -C <collection> -U <user> -P <password>"
           exit 1;;
     esac
   done

   if [ "$VWORKINGDIR" == "" ]; then
      VWORKINGDIR="/tmp"
   fi

   if [ "$VCOLLECTION" == "" ]; then
      echo "Collection name must be specified"
      echo "Use the -C <collection> option"
      exit 1
   fi

   if [ "$VUSER" == "" ]; then
      VUSER=$VIVUSER
      if [ "$VUSER" == "" ]; then
         echo "Vivisimo username is needed"
         echo "Either set VIVUSER environment variable or"
         echo "use the -U <vivuser> options"
         exit 1
      fi
   fi

   if [ "$VPW" == "" ]; then
      VPW=$VIVPW
      if [ "$VPW" == "" ]; then
         echo "Vivisimo password is needed"
         echo "Either set VIVPW environment variable or"
         echo "use the -P <vivpassword> options"
         exit 1
      fi
   fi

   if [ "$HOST" == "" ]; then
      HOST=$VIVHOST
   fi

   if [ "$HOST" == "" ]; then
      if [ "$VWWWUSER" == "" ]; then
         VWWWUSER=$WWWUSER
         if [ "$VWWWUSER" == "" ]; then
            echo "apache/httpd user is needed"
            echo "Set WWWUSER environment variable"
            exit 1
         fi
      fi
   fi
}

useadmincmd()
{
   VINSTALL=$VIVISIMO_INSTALL_DIR
   if [ "$VINSTALL" == "" ]; then
      VINSTALL="/usr/local/vivisimo-"
   fi

   mydir="data/collections/$VCOLLECTION"
   colfile="data/collections/$VCOLLECTION.xml"

   rstring="sudo -u $VWWWUSER bin/admin-cmd --login $VUSER:$VPW $VCMD 'id=se.overview&collection=$VCOLLECTION&action=$VACTION'"

   if [ "$VERSION_FORCE" != "" ]; then
      cd $VINSTALL$VERSION_FORCE
   else
      cd $VINSTALL
   fi

   if [ -f $colfile ]; then
      cp -f $colfile $VWORKINGDIR/$VCOLLECTION.xml
   fi
}

usewget()
{

   rstring="wget 'http://$HOST/vivisimo/cgi-bin/$ADMINCMD?id=se.overview&collection=$VCOLLECTION&action=$VACTION&username=$VUSER&password=$VPW' -o $VCOLLECTION.crwllog -O $VCOLLECTION.crwlout"
}

getsetopts $*

if [ "$HOST" == "" ]; then
   useadmincmd
else
   usewget
fi

eval $rstring 2>/dev/null

exit 0

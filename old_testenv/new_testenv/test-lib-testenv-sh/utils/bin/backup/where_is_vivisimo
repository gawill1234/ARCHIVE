#!/bin/bash


#############################################################

   VUSER=""
   VPW=""
   VWWWUSER=""
   SHOST=""
   TARGETOS="$VIVTARGETOS"

   VCMD="gronk"
   if [ "$TARGETOS" == "windows" ]; then
      VCMD="gronk.exe"
   fi

   VACTION="installed-dir"
   export PATH=$PATH:$TEST_ROOT/utils/bin:$TEST_ROOT/bin

#############################################################

getsetopts()
{
   OPTERR=0
   OPTIND=1
   while getopts "H:U:P:" flag; do
     case "$flag" in
        H) SHOST=$OPTARG;;
        U) VUSER=$OPTARG;;
        P) VPW=$OPTARG;;
        *) echo "Usage: get_file -F <file> -D <fromdir> -U <user> -P <password>"
           exit 1;;
     esac
   done

   if [ "$VUSER" == "" ]; then
      VUSER=$VIVUSER
      if [ "$VUSER" == "" ]; then
         echo "Vivisimo username is needed"
         echo "Either set VIVUSER environment variable or"
         echo "use the -U <vivuser> options"
         exit 1
      fi
   fi

   if [ "$VPW" == "" ]; then
      VPW=$VIVPW
      if [ "$VPW" == "" ]; then
         echo "Vivisimo password is needed"
         echo "Either set VIVPW environment variable or"
         echo "use the -P <vivpassword> options"
         exit 1
      fi
   fi

   if [ "$SHOST" == "" ]; then
      SHOST=$VIVHOST
   fi

}

usewget()
{
   rstring="wget 'http://$SHOST/vivisimo/cgi-bin/$VCMD?action=$VACTION' -o install.dir.getlog -O install.dir"
}

getsetopts $*

retry=0

usewget

eval $rstring

if [ ! -f install.dir ]; then
   exit 1
fi

xyz=`stat -c %s install.dir`
if [ $xyz -gt 0 ]; then
   xsltproc $TEST_ROOT/utils/xsl/op_where.xsl install.dir > /tmp/instyjunk

   if [ -f /tmp/instyjunk ]; then
      xyz=`stat -c %s /tmp/instyjunk`
      if [ $xyz -gt 0 ]; then
         name=`grep -v "\?xml" /tmp/instyjunk`
      fi
      rm /tmp/instyjunk
   fi

   rm install.dir install.dir.getlog

   echo $name
else
   exit 1
fi

exit 0

#!/bin/bash
#
#   Pyed
#
   

######################################################

   VUSER="$VIVUSER"
   VPW="$VIVPW"
   SHOST="$VIVHOST"
   VCOLLECTION="$VIVCOLLECTION"
   VWWWUSER=""
   TARGETOS="$VIVTARGETOS"
   
   ADMINCMD="admin"
   if [ "$TARGETOS" == "windows" ]; then
      ADMINCMD="admin.exe"
   fi
   VCMD="cgi-string"
   VACTION="delete"
   export PATH=$PATH:$TEST_ROOT/utils/bin:$TEST_ROOT/bin

   GRONK="gronk"
   if [ "$TARGETOS" == "windows" ] || [ "$VIVTARGETOS" == "windows" ]; then
      GRONK="gronk.exe"
   fi

   force=0

######################################################

getsetopts()
{
   
   while getopts "C:H:U:P:f" flag; do
     case "$flag" in
        C) VCOLLECTION=$OPTARG;;
        H) SHOST=$OPTARG;;
        U) VUSER=$OPTARG;;
        P) VPW=$OPTARG;;
        f) force=1;;
        *) echo "Usage: check_crawl -C <collection> -U <user> -P <password>"
           exit 1;;
     esac
   done
   
   if [ "$VCOLLECTION" == "" ]; then
      echo "Collection name must be specified"
      echo "Use the -C <collection> option"
      exit 1
   fi
   
   if [ "$VUSER" == "" ]; then
      echo "Vivisimo username is needed"
      echo "Either set VIVUSER environment variable or"
      echo "use the -U <vivuser> options"
      exit 1
   fi
   
   if [ "$VPW" == "" ]; then
      echo "Vivisimo password is needed"
      echo "Either set VIVPW environment variable or"
      echo "use the -P <vivpassword> options"
      exit 1
   fi

   if [ "$SHOST" == "" ]; then
      if [ "$VWWWUSER" == "" ]; then
         VWWWUSER=$WWWUSER
         if [ "$VWWWUSER" == "" ]; then
            echo "apache/httpd user is needed"
            echo "Set WWWUSER environment variable"
            exit 1
         fi
      fi
   fi
}
   
useadmincmd()
{
   
   VINSTALL=$VIVISIMO_INSTALL_DIR
   if [ "$VINSTALL" == "" ]; then
      VINSTALL="/usr/local/vivisimo-"
   fi
   
   ./which_index -C $VCOLLECTION -e
   exists=$?
   
   if [ $exists -ne 0 ]; then
      echo "Collection $VCOLLECTION does not exist"
      exit 1
   fi
   
   if [ "$VERSION_FORCE" != "" ]; then
      cd $VINSTALL$VERSION_FORCE
   else
      cd $VINSTALL
   fi
   
   cd data/collections
   
   sudo -u $VWWWUSER rm -f $VCOLLECTION.xml.lock
   sudo -u $VWWWUSER rm -f $VCOLLECTION.xml
   sudo -u $VWWWUSER rm -rf $VCOLLECTION
}

useforce()
{
   rstring="wget 'http://$SHOST/vivisimo/cgi-bin/$GRONK?collection=$VCOLLECTION&action=rm-collection' -o $VCOLLECTION.delcollog -O $VCOLLECTION.delcol"
   eval $rstring 2>/dev/null

}

unloader()
{

   echo "Unloading collection"

   rstring="wget 'http://$SHOST/vivisimo/cgi-bin/$ADMINCMD?id=se.qs_status&collection=$VCOLLECTION&unload=$VCOLLECTION&action=unload&username=$VUSER&password=$VPW' -o $VCOLLECTION.unlcollog -O $VCOLLECTION.unlcol"

   #echo $rstring
   eval $rstring 2>/dev/null
}

usewget()
{

   rstring="wget 'http://$SHOST/vivisimo/cgi-bin/$ADMINCMD?id=se.overview&collection=$VCOLLECTION&delete=$VCOLLECTION&action=$VACTION&username=$VUSER&password=$VPW' -o $VCOLLECTION.delcollog -O $VCOLLECTION.delcol"

   #echo $rstring
   eval $rstring 2>/dev/null
}

getsetopts $*
qsstop=0

if [ "$TARGETOS" == "windows" ]; then
   query_service_status -H $SHOST
   if [ $? -eq 1 ]; then
      echo "stop_query_service -H $SHOST -U $VUSER -P $VPW"
      stop_query_service -H $SHOST -U $VUSER -P $VPW
      qsstop=1
   fi
fi

if [ "$SHOST" == "" ]; then
   useadmincmd
else
   #unloader
   if [ $force -eq 1 ]; then
      useforce
   else
      usewget
   fi
fi

if [ $qsstop -eq 1 ]; then
   echo "start_query_service -H $SHOST -U $VUSER -P $VPW"
   start_query_service -H $SHOST -U $VUSER -P $VPW
fi

collection_exists -C $VCOLLECTION -H $SHOST -U $VUSER -P $VPW
if [ $? -eq 0 ]; then
   #
   #   The collection has been successfully deleted.
   #
   exit 0
fi

#
#   The collection still exists.  Delete failed.
#
exit 1


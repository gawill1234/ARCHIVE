#!/bin/bash

fail=0
fclean=0
pclean=0

VTESTROOT=$TESTROOT
VWORKINGDIR=$TESTWORKINGDIR

VOUTHASH=""
VINHASH=""
VSAVE=""

VCOLLECTION=""

while getopts "C:T:W:I:O:S:cn" flag; do
  case "$flag" in
     C) VCOLLECTION=$OPTARG;;
     T) VTESTROOT=$OPTARG;;
     I) VINHASH=$OPTARG;;
     O) VOUTHASH=$OPTARG;;
     W) VWORKINGDIR=$OPTARG;;
     S) VSAVE=$OPTARG;;
     c) fclean=1;;
     n) pclean=1;;
     *) echo "Usage: dump_index -C <collection> [ -T <testroot>"
        echo "                   -I <inhash> -O <outhash>"
        echo "                   -W <workingdir> -S <savepath>]"
        exit 1;;
  esac
done

if [ "$VCOLLECTION" == "" ]; then
   echo "Collection name must be specified"
   echo "Use the -C <collection> option"
   exit 1
fi

if [ "$VTESTROOT" == "" ]; then
   echo "Test root is needed"
   echo "Either set TESTROOT environment variable or"
   echo "use the -T <testroot> options"
   exit 1
fi

if [ "$VWORKINGDIR" == "" ]; then
   VWORKINGDIR="/tmp"
fi

if [ "$VOUTHASH" == "" ]; then
   VOUTHASH="$VWORKINGDIR/$VCOLLECTION.compare.hash"
fi

if [ "$VINHASH" == "" ]; then
   VINHASH="$VTESTROOT/tests/data/collection_data/$VCOLLECTION.good.hash"
fi

if [ ! -f $VINHASH ]; then
   echo "$VINHASH does not exist"
   VINHASH=""
else
   filename=`basename $VINHASH`
   cp $VINHASH $VWORKINGDIR/$filename
   VINHASH=$VWORKINGDIR/$filename
fi

VINSTALL=$VIVISIMO_INSTALL_DIR
if [ "$VINSTALL" == "" ]; then
   VINSTALL="/usr/local/vivisimo-"
fi

mydir="data/collections/$VCOLLECTION"

if [ "$VERSION_FORCE" != "" ]; then
   cd $VINSTALL$VERSION_FORCE
else
   cd $VINSTALL
fi

VDUMPOUTPUT=$VWORKINGDIR/dump.stdout
VDUMPERROUT=$VWORKINGDIR/dump.stderr

if [ -f "$mydir/index0" ]; then
   thedir="$mydir/crawl0"
   theindex="$mydir/index0"
else
   if [ -f "$mydir/index1" ]; then
      thedir="$mydir/crawl1"
      theindex="$mydir/index1"
   else
      echo "Collection $VCOLLECTION does not exist"
      exit 1
   fi
fi

echo "$thedir"

if [ "$VINHASH" == "" ]; then
   bin/dump -exclude crawled-date -urls -url-hash-out $VOUTHASH $thedir/0000000000.xml $theindex > $VDUMPOUTPUT 2> $VDUMPERROUT

   echo dump has been run

   if [ "$VSAVE" != "" ]; then
      cp $VOUTHASH $VSAVE
      echo File $VOUTHASH has been saved to $VSAVE
   fi

   exit 0
else
   bin/dump -exclude crawled-date -urls -url-hash-out $VOUTHASH.alone $thedir/0000000000.xml $theindex > $VDUMPOUTPUT 2> $VDUMPERROUT

   outlines=`stat -c "%s" $VOUTHASH.alone`
   inlines=`stat -c "%s" $VINHASH`

   if [ $outlines -ne $inlines ]; then
      echo "Warning:  Hash files are different sizes"
      echo "$VINHASH:  $inlines"
      echo "$VOUTHASH.alone:  $outlines"
   fi
   
   bin/dump -exclude crawled-date -urls -url-hash-in $VINHASH -url-hash-out $VOUTHASH $thedir/0000000000.xml $theindex > $VDUMPOUTPUT 2> $VDUMPERROUT

   cut -d ' ' -f 2 $VOUTHASH.alone > $VWORKINGDIR/$VCOLLECTION.alone.compare.cut
   cut -d ' ' -f 2 $VINHASH > $VWORKINGDIR/$VCOLLECTION.good.cut

   sort $VWORKINGDIR/$VCOLLECTION.alone.compare.cut > $VWORKINGDIR/$VCOLLECTION.compare.cut.sort
   sort $VWORKINGDIR/$VCOLLECTION.good.cut > $VWORKINGDIR/$VCOLLECTION.good.cut.sort

   sort $VOUTHASH > $VWORKINGDIR/$VCOLLECTION.compare.sort
   sort $VINHASH > $VWORKINGDIR/$VCOLLECTION.good.sort

   echo "#####   First diff"
   echo "diff $VWORKINGDIR/$VCOLLECTION.good.sort $VWORKINGDIR/$VCOLLECTION.compare.sort"
   diff $VWORKINGDIR/$VCOLLECTION.good.sort $VWORKINGDIR/$VCOLLECTION.compare.sort
   diffres=$?

   fail=`expr $fail + $diffres`

   echo "#####   Second diff"
   diff $VWORKINGDIR/$VCOLLECTION.good.cut.sort $VWORKINGDIR/$VCOLLECTION.compare.cut.sort
   diffres=$?

   fail=`expr $fail + $diffres`

   if [ $fail -ne 0 ]; then
      echo Differences detected
      if [ $fclean -eq 1 ]; then
         rm $VWORKINGDIR/$VCOLLECTION.alone.compare.cut
         rm $VWORKINGDIR/$VCOLLECTION.compare.cut.sort
         rm $VWORKINGDIR/$VCOLLECTION.good.cut
         rm $VWORKINGDIR/$VCOLLECTION.good.cut.sort
         rm $VWORKINGDIR/$VCOLLECTION.compare.sort
         rm $VWORKINGDIR/$VCOLLECTION.good.sort
         rm $VWORKINGDIR/$VCOLLECTION.good.hash
         rm $VWORKINGDIR/$VCOLLECTION.compare.hash
         rm $VWORKINGDIR/$VCOLLECTION.compare.hash.alone
      fi
      exit 1
   else
      echo Compared files are identical
      if [ $pclean -eq 0 ]; then
         rm $VWORKINGDIR/$VCOLLECTION.alone.compare.cut
         rm $VWORKINGDIR/$VCOLLECTION.compare.cut.sort
         rm $VWORKINGDIR/$VCOLLECTION.good.cut
         rm $VWORKINGDIR/$VCOLLECTION.good.cut.sort
         rm $VWORKINGDIR/$VCOLLECTION.compare.sort
         rm $VWORKINGDIR/$VCOLLECTION.good.sort
         rm $VWORKINGDIR/$VCOLLECTION.good.hash
         rm $VWORKINGDIR/$VCOLLECTION.compare.hash
         rm $VWORKINGDIR/$VCOLLECTION.compare.hash.alone
      fi
      exit 0
   fi
fi

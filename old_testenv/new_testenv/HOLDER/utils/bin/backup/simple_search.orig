#!/bin/bash

usescore=0
dumpit=0
timeit=0
VUSER=$VIVUSER
VPW=$VIVPW
VCOLLECTION=$VIVCOLLECTION
HOST=$VIVHOST
PORT=$VIVPORT
QUERY=$VIVQUERY
DEFOUTPUT=$VIVQUERYOUTPUT
LOGFILE=$VIVLOGFILE
SEARCH_FILE_DIR=$FILE_SEED_HOME

while getopts "DC:U:P:Q:H:p:O:L:T:S:s" flag; do
  case "$flag" in
     C) VCOLLECTION=$OPTARG;;
     U) VUSER=$OPTARG;;
     P) VPW=$OPTARG;;
     Q) QUERY=$OPTARG;;
     H) HOST=$OPTARG;;
     p) PORT=$OPTARG;;
     O) DEFOUTPUT=$OPTARG;;
     L) LOGFILE=$OPTARG;;
     S) SEARCH_FILE_DIR=$OPTARG;;
     D) dumpit=1;;
     T) TESTNAME=$OPTARG;;
     s) usescore=1;;
     *) echo "Usage: run_query -C <collection> -U <user> -P <password>"
        echo "                 -Q <query> -H <hostid> -p <port>"
        echo "                 -O <query-output-file> -L <query-log-file>"
        echo "                 -S <file-seed-home-directory> -s"
        exit 1;;
  esac
done

if [ "$VCOLLECTION" == "" ]; then
   echo "Collection name must be specified"
   echo "Use the -C <collection> option"
   exit 1
fi

if [ "$QUERY" == "" ]; then
   echo "Query must be specified"
   echo "Use the -Q <query> option"
   exit 1
fi

if [ "$PORT" != "" ]; then
   export VIVPORT=$PORT
else
   export VIVPORT=7205
fi

if [ "$HOST" != "" ]; then
   export VIVHOST=$HOST
fi

if [ "$LOGFILE" == "" ]; then
   LOGFILE=/dev/null
fi

if [ "$DEFOUTPUT" == "" ]; then
   DEFOUTPUT="query_results"
fi

if [ "$VUSER" != "" ]; then
   export VIVUSER=$VUSER
fi

if [ "$VPW" != "" ]; then
   export VIVPW=$VPW
fi

if [ "$dumpit" -eq 1 ]; then
   echo "Collection = $VCOLLECTION  (-C option) or (VIVCOLLECTION env var)"
   echo "Query = $QUERY             (-Q option) or (VIVQUERY env var)"
   echo "Output file = $DEFOUTPUT   (-O option) or (VIVQUERYOUTPUT env var)"
   echo "Log file = $LOGFILE        (-L option) or (VIVLOGFILE env var)"
   echo "Host = $HOST               (-H option) or (VIVHOST env var)"
   echo "Port = $PORT               (-p option) or (VIVPORT env var)"
   echo "User = $VUSER              (-U option) or (VIVUSER env var)"
   echo "Password = $VPW            (-P option) or (VIVCOLLECTION env var)"
   exit 0
fi

if [ "$SEARCH_FILE_DIR" != "" ]; then
   filename=`mktemp`
   echo $SEARCH_FILE_DIR | sed "s/\//\\\\\//g" > $filename
   replstr=`cat $filename`
   xxx="sed \"s/\/home\/williams/$replstr/g\""
   rm $filename
else
   SEARCH_FILE_DIR=/tmp/thesearchers
fi

echo "################  $TESTNAME start  ##################"
echo "$TESTNAME:  query = $QUERY"

rstring="$TEST_ROOT/utils/bin/run_query -C $VCOLLECTION -Q $QUERY -O $QUERY.rslt"

eval $rstring

cp $TEST_ROOT/files/$VCOLLECTION/compare_files/$QUERY.cmp .

if [ $usescore -eq 1 ]; then
   xsltproc $TEST_ROOT/utils/xsl/stripper $QUERY.rslt > $QUERY.newrslt.xml
   xsltproc $TEST_ROOT/utils/xsl/stripper $QUERY.cmp | eval $xxx > $QUERY.heldcmp.xml
else
   xsltproc $TEST_ROOT/utils/xsl/noscore_stripper $QUERY.rslt > $QUERY.newrslt.xml
   xsltproc $TEST_ROOT/utils/xsl/noscore_stripper $QUERY.cmp | eval $xxx > $QUERY.heldcmp.xml
fi
diff $QUERY.newrslt.xml $QUERY.heldcmp.xml > $QUERY.xml.diff
res1=$?
diff $QUERY.rslt $QUERY.cmp > $QUERY.rsltcmp.diff
res2=$?

if [ $res2 -ne 0 ];then
   echo "$TESTNAME:  WARNING"
   echo "$TESTNAME:      Search on query $QUERY returned a result file"
   echo "$TESTNAME:      that is different than that which is stored for comparison"
fi

if [ $res1 -eq 0 ];then
   echo "$TESTNAME:  Test Passed"
   #if [ $res2 -eq 0 ];then
      rm $QUERY.rslt $QUERY.cmp $QUERY.newrslt.xml $QUERY.heldcmp.xml $QUERY.xml.diff $QUERY.rsltcmp.diff
   #fi
else
   echo "$TESTNAME:  Test Failed"
fi
echo "################  $TESTNAME end    ##################"

if [ $res1 -eq 0 ];then
   exit 0
else
   exit 1
fi
